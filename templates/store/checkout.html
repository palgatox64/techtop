{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
    <link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block title %}Finalizar Compra - Techtop{% endblock %}

{% block content %}
<div class="cart-container checkout-container">

    <div class="cart-main checkout-main">
        <h2>Finalizar Compra</h2>

        <form id="checkout-form" method="POST" action="{% url 'procesar_pedido' %}">
            {% csrf_token %}

            <section class="checkout-section">
                <h3>1. Datos de Contacto</h3>
                <div class="form-grid">
                    <div class="form-group full-width {% if form.email.errors %}has-error{% endif %}">
                        <label for="{{ form.email.id_for_label }}">Email*</label>
                        {{ form.email }}
                        {% if form.email.errors %}<small class="error-text">{{ form.email.errors.0 }}</small>{% endif %}
                    </div>
                    <div class="form-group {% if form.nombre.errors %}has-error{% endif %}">
                        <label for="{{ form.nombre.id_for_label }}">Nombre*</label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}<small class="error-text">{{ form.nombre.errors.0 }}</small>{% endif %}
                    </div>
                    <div class="form-group {% if form.apellidos.errors %}has-error{% endif %}">
                        <label for="{{ form.apellidos.id_for_label }}">Apellidos*</label>
                        {{ form.apellidos }}
                        {% if form.apellidos.errors %}<small class="error-text">{{ form.apellidos.errors.0 }}</small>{% endif %}
                    </div>
                    <div class="form-group {% if form.rut.errors %}has-error{% endif %}">
                        <label for="{{ form.rut.id_for_label }}">RUT*</label>
                        {{ form.rut }}
                        {% if form.rut.errors %}<small class="error-text">{{ form.rut.errors.0 }}</small>{% endif %}
                    </div>
                    <div class="form-group {% if form.telefono.errors %}has-error{% endif %}">
                        <label for="{{ form.telefono.id_for_label }}">Tel√©fono* (Ej: 987654321)</label>
                        {{ form.telefono }}
                        {% if form.telefono.errors %}<small class="error-text">{{ form.telefono.errors.0 }}</small>{% endif %}
                    </div>
                </div>
            </section>

            <section class="checkout-section">
                <h3>2. M√©todo de Entrega</h3>
                <div class="radio-options" id="delivery-options-container">
                    {% for choice in form.tipo_entrega.field.choices %}
                        <label class="radio-label" for="id_tipo_entrega_{{ forloop.counter0 }}">
                            <input type="radio"
                                   name="{{ form.tipo_entrega.name }}"
                                   id="id_tipo_entrega_{{ forloop.counter0 }}"
                                   value="{{ choice.0 }}"
                                   {% if form.tipo_entrega.value == choice.0 or not form.tipo_entrega.value and form.tipo_entrega.field.initial == choice.0 %}checked{% endif %}>
                            <div class="radio-content">
                                <span class="radio-title">{{ choice.1 }}</span>
                                {% if choice.0 == 'delivery' %}
                                <span class="radio-desc">Recibe tu pedido en casa (costo adicional).</span>
                                {% elif choice.0 == 'retiro' %}
                                <span class="radio-desc">Retira gratis en nuestra tienda.</span>
                                {% endif %}
                            </div>
                        </label>
                    {% endfor %}
                </div>

                <div id="delivery-address-form" class="address-form-hidden">
                    <h4 class="delivery-form-title">Direcci√≥n de Env√≠o</h4>
                    <div class="delivery-address-form-grid">
                        <div class="form-group full-width {% if form.calle.errors %}has-error{% endif %}">
                            <label for="{{ form.calle.id_for_label }}">Calle*</label>
                            {{ form.calle }}
                            {% if form.calle.errors %}<small class="error-text">{{ form.calle.errors.0 }}</small>{% endif %}
                        </div>
                        <div class="form-group {% if form.numero.errors %}has-error{% endif %}">
                            <label for="{{ form.numero.id_for_label }}">N√∫mero*</label>
                            {{ form.numero }}
                            {% if form.numero.errors %}<small class="error-text">{{ form.numero.errors.0 }}</small>{% endif %}
                        </div>
                        <div class="form-group {% if form.tipo_vivienda.errors %}has-error{% endif %}">
                            <label for="{{ form.tipo_vivienda.id_for_label }}">Tipo de Vivienda*</label>
                            {{ form.tipo_vivienda }}
                            {% if form.tipo_vivienda.errors %}<small class="error-text">{{ form.tipo_vivienda.errors.0 }}</small>{% endif %}
                        </div>
                        <div class="form-group full-width {% if form.depto_pasaje.errors %}has-error{% endif %}">
                            <label for="{{ form.depto_pasaje.id_for_label }}">Depto / Pasaje / Villa (Opcional)</label>
                            {{ form.depto_pasaje }}
                            {% if form.depto_pasaje.errors %}<small class="error-text">{{ form.depto_pasaje.errors.0 }}</small>{% endif %}
                        </div>
                        <div class="form-group full-width {% if form.codigo_postal.errors %}has-error{% endif %}">
                            <label for="{{ form.codigo_postal.id_for_label }}">C√≥digo Postal (Opcional)</label>
                            {{ form.codigo_postal }}
                            {% if form.codigo_postal.errors %}<small class="error-text">{{ form.codigo_postal.errors.0 }}</small>{% endif %}
                        </div>
                    </div>
                </div>
                 {% if form.non_field_errors %}
                    <div class="form-errors global-errors">
                        {% for error in form.non_field_errors %}<small class="error-text">{{ error }}</small>{% endfor %}
                    </div>
                {% endif %}
            </section>

            <section class="checkout-section">
                <h3>3. M√©todo de Pago</h3>
                <div class="payment-methods-grid">
                    {% for choice in form.metodo_pago.field.choices %}
                        <label class="payment-method-card" for="id_metodo_pago_{{ forloop.counter0 }}">
                            <input type="radio"
                                   name="{{ form.metodo_pago.name }}"
                                   id="id_metodo_pago_{{ forloop.counter0 }}"
                                   value="{{ choice.0 }}"
                                   {% if form.metodo_pago.value == choice.0 or not form.metodo_pago.value and form.metodo_pago.field.initial == choice.0 %}checked{% endif %}>
                            
                            <div class="payment-method-content">
                                <div class="payment-logo-container">
                                    {% if choice.0 == 'webpay' %}
                                        <img src="{% static 'img/logo_webpay.png' %}" alt="Webpay" class="payment-logo-img">
                                    {% elif choice.0 == 'mercadopago' %}
                                        <img src="{% static 'img/logo_mercadopago.png' %}" alt="Mercado Pago" class="payment-logo-img">
                                    {% elif choice.0 == 'transferencia' %}
                                        <img src="{% static 'img/transferencia.webp' %}" alt="Transferencia" class="payment-logo-img">
                                    {% endif %}
                                </div>
                                <div class="payment-check-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                    </svg>
                                </div>
                            </div>
                        </label>
                    {% endfor %}
                </div>
                 {% if form.metodo_pago.errors %}
                    <div class="form-errors">
                        <small class="error-text">{{ form.metodo_pago.errors.0 }}</small>
                    </div>
                 {% endif %}

                
                <div id="webpay-info" style="display: none; margin-top: 20px; background: #eff6ff; border-left: 4px solid #3b82f6; padding: 15px 20px; border-radius: 4px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px; color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        <h4 style="margin: 0; color: #1e40af; font-size: 16px;">‚úÖ Pago Seguro con Transbank WebPay Plus</h4>
                    </div>
                    <p style="margin: 5px 0; color: #1e40af; font-size: 14px;">
                        üîí Tu pago ser√° procesado de forma segura a trav√©s de <strong>Transbank</strong>, la plataforma de pagos m√°s confiable de Chile.
                    </p>
                    <p style="margin: 5px 0; color: #1e40af; font-size: 14px;">
                        üí≥ Acepta tarjetas: <strong>Visa, Mastercard, American Express, Diners Club</strong> y m√°s.
                    </p>
                    <p style="margin: 10px 0 0 0; color: #1e40af; font-size: 13px; font-weight: 600;">
                        ‚ö° Despu√©s de hacer clic en "Finalizar Compra", ser√°s redirigido a la p√°gina segura de Transbank para completar tu pago.
                    </p>
                </div>

                
                <div id="transferencia-info" style="display: none; margin-top: 20px; background: #ecfdf5; border-left: 4px solid #10b981; padding: 15px 20px; border-radius: 4px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px; color: #10b981;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h4 style="margin: 0; color: #065f46; font-size: 16px;">üí∏ ¬°Ahorra 3% con Transferencia Bancaria!</h4>
                    </div>
                    <p style="margin: 5px 0; color: #065f46; font-size: 14px;">
                        üìã Despu√©s de finalizar tu compra, recibir√°s los datos bancarios para realizar la transferencia.
                    </p>
                    <p style="margin: 5px 0; color: #065f46; font-size: 14px;">
                        ‚è±Ô∏è Tu pedido se procesar√° una vez confirmemos el pago (24-48 hrs).
                    </p>
                </div>

                
                <div id="mercadopago-info" style="display: none; margin-top: 20px; background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px 20px; border-radius: 4px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #92400e; font-size: 16px;">üí≥ Mercado Pago</h4>
                    </div>
                    <p style="margin: 5px 0; color: #92400e; font-size: 14px;">
                        Paga de forma segura con Mercado Pago. Acepta tarjetas de cr√©dito y d√©bito.
                    </p>
                </div>
            </section>

        </form>
    </div>

    <div class="cart-summary">
        <h3>Resumen ({{ cart_items|length }} producto{% if cart_items|length != 1 %}s{% endif %})</h3>

        <div class="summary-items-list">
            {% for item in cart_items %}
            <div class="summary-item-product">
                <img src="{{ item.product.imagen.url }}" alt="{{ item.product.nombre }}">
                <div class="summary-item-details">
                    <span class="summary-item-name">{{ item.product.nombre }} (x{{ item.quantity }})</span>
                    <span class="summary-item-price">${{ item.subtotal_otros_medios|floatformat:0|dot_thousands }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        <hr class="summary-divider">

        <div class="summary-item">
            <span>Pago con transferencias</span>
            
            <strong id="subtotal-transferencia">${{ total_transferencia|floatformat:0|dot_thousands }}</strong>
        </div>
        <div class="summary-item-label">
            <span>Transferencia y Banco Estado</span>
        </div>
        <div class="summary-item">
            <span>Otros medios de pago</span>
             
            <strong id="subtotal-otros-medios">${{ total_otros_medios|floatformat:0|dot_thousands }}</strong>
        </div>
        <div class="summary-item-label">
            <span>Webpay/Onepay</span>
        </div>

        
        <div class="summary-item" id="summary-delivery-cost" style="display: none;">
            <span>Costo de Env√≠o</span>
            <strong id="delivery-cost-value">$4.500</strong>
        </div>

        <div class="summary-total">
            <span>TOTAL</span>
             
            <span id="summary-total-value">-</span>
        </div>

        <button type="submit" form="checkout-form" class="btn-checkout" id="btn-finalizar-compra">
            Finalizar Compra
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('checkout-form');
    const submitBtn = document.getElementById('btn-finalizar-compra');
    const deliveryOptions = document.querySelectorAll('input[name="tipo_entrega"]');
    const paymentOptions = document.querySelectorAll('input[name="metodo_pago"]'); 
    const addressForm = document.getElementById('delivery-address-form');

    
    const webpayInfo = document.getElementById('webpay-info');
    const transferenciaInfo = document.getElementById('transferencia-info');
    const mercadopagoInfo = document.getElementById('mercadopago-info');

    
    const subtotalTransferenciaElement = document.getElementById('subtotal-transferencia');
    const subtotalOtrosMediosElement = document.getElementById('subtotal-otros-medios');
    const summaryTotalValueElement = document.getElementById('summary-total-value');
    const summaryDeliveryCostElement = document.getElementById('summary-delivery-cost'); 
    const deliveryCostValue = 4500; 

    
    const emailInput = document.getElementById('{{ form.email.id_for_label }}');
    const nombreInput = document.getElementById('{{ form.nombre.id_for_label }}');
    const apellidosInput = document.getElementById('{{ form.apellidos.id_for_label }}');
    const rutInput = document.getElementById('{{ form.rut.id_for_label }}');
    const telefonoInput = document.getElementById('{{ form.telefono.id_for_label }}');
    const calleInput = document.getElementById('{{ form.calle.id_for_label }}');
    const numeroInput = document.getElementById('{{ form.numero.id_for_label }}');
    const tipoViviendaSelect = document.getElementById('{{ form.tipo_vivienda.id_for_label }}');


    
    function formatCurrency(value) {
        return value.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 });
    }

    
    function getBasePrices() {
        
        const transferText = subtotalTransferenciaElement.textContent.replace(/[$.]/g, '');
        const otherText = subtotalOtrosMediosElement.textContent.replace(/[$.]/g, '');
        return {
            transferencia: parseInt(transferText, 10) || 0,
            otrosMedios: parseInt(otherText, 10) || 0
        };
    }
    const basePrices = getBasePrices(); 


    
    function updateTotal() {
        console.log("Actualizando total..."); 
        const selectedDeliveryOption = document.querySelector('input[name="tipo_entrega"]:checked');
        const selectedPaymentOption = document.querySelector('input[name="metodo_pago"]:checked');

        let currentSubtotal = 0;
        let deliveryCost = 0;

        
        if (selectedPaymentOption) {
            console.log("M√©todo de pago:", selectedPaymentOption.value); 
            if (selectedPaymentOption.value === 'transferencia') {
                currentSubtotal = basePrices.transferencia;
            } else { 
                currentSubtotal = basePrices.otrosMedios;
            }
        } else {
             
            currentSubtotal = basePrices.otrosMedios;
        }
        console.log("Subtotal base:", currentSubtotal); 
        console.log("Subtotal base:", currentSubtotal); 

        
        if (selectedDeliveryOption) {
            console.log("M√©todo de entrega:", selectedDeliveryOption.value); 
            if (selectedDeliveryOption.value === 'delivery') {
                deliveryCost = deliveryCostValue;
                summaryDeliveryCostElement.style.display = 'flex'; 
            } else { 
                deliveryCost = 0;
                summaryDeliveryCostElement.style.display = 'none';
            }
        } else {
             
             deliveryCost = 0;
             summaryDeliveryCostElement.style.display = 'none';
        }
        console.log("Costo env√≠o:", deliveryCost); 

        
        const finalTotal = currentSubtotal + deliveryCost;
        console.log("Total final:", finalTotal); 

        
        summaryTotalValueElement.textContent = formatCurrency(finalTotal);
    }

    
    function updatePaymentInfo() {
        const selectedPaymentOption = document.querySelector('input[name="metodo_pago"]:checked');
        
        
        webpayInfo.style.display = 'none';
        transferenciaInfo.style.display = 'none';
        mercadopagoInfo.style.display = 'none';
        
        
        if (selectedPaymentOption) {
            if (selectedPaymentOption.value === 'webpay') {
                webpayInfo.style.display = 'block';
            } else if (selectedPaymentOption.value === 'transferencia') {
                transferenciaInfo.style.display = 'block';
            } else if (selectedPaymentOption.value === 'mercadopago') {
                mercadopagoInfo.style.display = 'block';
            }
        }
    }


    
    function showErrorAlert(message) {
        Swal.fire({
            icon: 'error',
            title: 'Datos Inv√°lidos',
            text: message,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Corregir'
        });
        submitBtn.disabled = false;
        submitBtn.textContent = 'Finalizar Compra';
    }

    
    function validateForm() {
        if (!emailInput.value.trim()) { showErrorAlert('El correo electr√≥nico es obligatorio.'); return false; }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(emailInput.value.trim())) { showErrorAlert('El formato del correo electr√≥nico no es v√°lido (ej: tu@correo.com).'); return false; }
        if (!nombreInput.value.trim()) { showErrorAlert('El nombre es obligatorio.'); return false; }
        const nameRegex = /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/;
        if (!nameRegex.test(nombreInput.value.trim())) { showErrorAlert('El nombre solo puede contener letras y espacios.'); return false; }
        if (!apellidosInput.value.trim()) { showErrorAlert('Los apellidos son obligatorios.'); return false; }
         if (!nameRegex.test(apellidosInput.value.trim())) { showErrorAlert('Los apellidos solo pueden contener letras y espacios.'); return false; }
        if (!rutInput.value.trim()) { showErrorAlert('El RUT es obligatorio.'); return false; }
        const rutLimpio = rutInput.value.replace(/[.-]/g, '');
        const rutRegex = /^[0-9]+[0-9Kk]$/;
        if (!rutRegex.test(rutLimpio)) { showErrorAlert('El RUT solo debe contener n√∫meros y la letra K (ej: 12345678-9).'); return false; }
        if (rutLimpio.length < 8 || rutLimpio.length > 10) { showErrorAlert('El RUT debe tener entre 8 y 10 caracteres (n√∫meros y d√≠gito verificador, sin puntos ni guion).'); return false; }
        if (!telefonoInput.value.trim()) { showErrorAlert('El tel√©fono es obligatorio.'); return false; }
        const phoneRegex = /^[0-9]{9}$/;
        if (!phoneRegex.test(telefonoInput.value.trim())) { showErrorAlert('El tel√©fono debe contener exactamente 9 n√∫meros (sin +56).'); return false; }
        const selectedDelivery = document.querySelector('input[name="tipo_entrega"]:checked');
        if (selectedDelivery && selectedDelivery.value === 'delivery') {
            if (!calleInput.value.trim()) { showErrorAlert('La calle es obligatoria para el delivery.'); return false; }
            if (!numeroInput.value.trim()) { showErrorAlert('El n√∫mero de casa/depto es obligatorio para el delivery.'); return false; }
             if (!tipoViviendaSelect.value) { showErrorAlert('Debes seleccionar un tipo de vivienda para el delivery.'); return false; }
        }
        const selectedPayment = document.querySelector('input[name="metodo_pago"]:checked');
         if (!selectedPayment) { showErrorAlert('Debes seleccionar un m√©todo de pago.'); return false; }
        return true;
    }

    
    function toggleAddressForm() {
        const checkedOption = document.querySelector('input[name="tipo_entrega"]:checked');
        if (!checkedOption) { addressForm.classList.add('address-form-hidden'); return; }
        const selectedValue = checkedOption.value;
        if (selectedValue === 'delivery') { addressForm.classList.remove('address-form-hidden'); }
        else { addressForm.classList.add('address-form-hidden'); }
    }
    deliveryOptions.forEach(option => {
        option.addEventListener('change', toggleAddressForm);
    });
    toggleAddressForm(); 

    
    deliveryOptions.forEach(option => {
        option.addEventListener('change', updateTotal); 
    });
    paymentOptions.forEach(option => {
        option.addEventListener('change', updateTotal); 
        option.addEventListener('change', updatePaymentInfo); 
    });
    updateTotal(); 
    updatePaymentInfo(); 


    
    form.addEventListener('submit', function (event) {
        event.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = 'Validando...';
        form.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));
        form.querySelectorAll('.error-text').forEach(el => el.textContent = '');
        if (!validateForm()) { return; }
        
        console.log("Validaci√≥n JS exitosa, enviando al backend...");
        submitBtn.textContent = 'Procesando...';
        
        const formData = new FormData(form);
        const selectedPayment = document.querySelector('input[name="metodo_pago"]:checked');
        const isWebpay = selectedPayment && selectedPayment.value === 'webpay';
        const isMercadoPago = selectedPayment && selectedPayment.value === 'mercadopago';
        
        fetch(form.action, { 
            method: 'POST', 
            body: formData, 
            headers: { 
                'X-CSRFToken': '{{ csrf_token }}', 
                'X-Requested-With': 'XMLHttpRequest' 
            } 
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (isWebpay) {
                    
                    Swal.fire({ 
                        icon: 'info', 
                        title: 'Redirigiendo a Webpay...', 
                        text: 'Ser√°s redirigido a la plataforma segura de Transbank para completar tu pago.', 
                        timer: 2000, 
                        showConfirmButton: false, 
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    })
                    .then(() => { 
                        window.location.href = data.redirect_url; 
                    });
                } else if (isMercadoPago) {
                    
                    Swal.fire({ 
                        icon: 'info', 
                        title: 'Redirigiendo a Mercado Pago...', 
                        text: 'Ser√°s redirigido a Mercado Pago para completar tu pago de forma segura.', 
                        timer: 2000, 
                        showConfirmButton: false, 
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    })
                    .then(() => { 
                        window.location.href = data.redirect_url; 
                    });
                } else {
                    
                    Swal.fire({ 
                        icon: 'success', 
                        title: '¬°Compra Exitosa!', 
                        text: data.message, 
                        timer: 3000, 
                        showConfirmButton: false, 
                        allowOutsideClick: false 
                    })
                    .then(() => { 
                        window.location.href = data.redirect_url; 
                    });
                }
            } else { 
                showErrorAlert(data.message || 'Ocurri√≥ un error en el servidor. Intenta de nuevo.'); 
            }
        })
        .catch(error => { 
            console.error('Error en la petici√≥n Fetch:', error); 
            showErrorAlert('No se pudo conectar con el servidor. Intenta m√°s tarde.'); 
        });
    });
});
</script>
{% endblock %}
