{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
{% endblock %}

{% block title %}{{ product.nombre }}{% endblock %}

{% block content %}
<div class="product-detail-container">
    
    <div class="product-gallery">
        <div class="gallery-thumbnails">
            {% if product.imagen %}
            <div class="thumb-item active" data-image="{{ product.imagen.url }}">
                <img src="{{ product.imagen.url }}" alt="Miniatura de {{ product.nombre }}">
            </div>
            {% endif %}
            
            {% for imagen in imagenes_adicionales %}
            <div class="thumb-item" data-image="{{ imagen.imagen.url }}">
                <img src="{{ imagen.imagen.url }}" alt="Miniatura adicional de {{ product.nombre }}">
            </div>
            {% endfor %}
        </div>
        <div class="gallery-main-image" id="image-zoom-container">
            <img id="main-product-image" src="{{ product.imagen.url }}" alt="{{ product.nombre }}">
        </div>
    </div>

    <div class="product-info-column">
        <h1>{{ product.nombre }}</h1>
        <p class="brand">Marca: <strong>{{ product.marca.nombre }}</strong></p>
        
        {# Mostrar tags del producto #}
        {% if product.tags.exists %}
        <div class="product-tags" style="margin: 15px 0;">
            {% for tag in product.tags.all %}
            <span class="product-tag" style="
                display: inline-block;
                background: {{ tag.color }};
                color: white;
                padding: 4px 12px;
                border-radius: 15px;
                font-size: 0.85rem;
                margin-right: 5px;
                margin-bottom: 5px;
            ">
                <i class='bx bx-purchase-tag'></i> {{ tag.nombre }}
            </span>
            {% endfor %}
        </div>
        {% endif %}

        <div class="price-box">
            {% if product.descuento > 0 %}
                <div class="price-item">
                    <span class="price-label">Precio Normal</span>
                    <span class="price-normal-strike">${{ product.precio|floatformat:0|dot_thousands }}</span>
                </div>
                <div class="price-item">
                     <span class="price-discount-badge">¡OFERTA -{{ product.descuento }}%!</span>
                </div>
            {% endif %}

            <div class="price-item main-price">
                <span class="price-label">
                    {% if product.descuento > 0 %}Precio Oferta{% else %}Precio Normal{% endif %}
                    (Otros medios de pago)
                </span>
                <span class="price-final">${{ product.precio_oferta|floatformat:0|dot_thousands }}</span>
            </div>

            <div class="price-item">
                <span class="price-label">
                    Pago con transferencia
                    {% if product.descuento > 0 %}
                       <small style="color: #28a745;">(Oferta + 3% extra)</small>
                    {% else %}
                       <small style="color: #28a745;">(Ahorra 3%)</small>
                    {% endif %}
                </span>
                <span class="price-other">${{ product.precio_transferencia|floatformat:0|dot_thousands }}</span>
            </div>
        </div>
        <div class="product-actions">
            <form action="{% url 'add_to_cart' product.id %}" method="POST" id="add-to-cart-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-secondary" {% if not producto_disponible %}disabled{% endif %}>
                    Agregar al carro
                </button>
            </form>

            <form action="{% url 'add_to_cart' product.id %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="next" value="checkout">
                <input type="hidden" name="quantity" value="1">
                
                <button type="submit" class="btn btn-primary" id="buy-now-btn" {% if not producto_disponible %}disabled{% endif %}>
                    Comprar ahora
                </button>
            </form>
        </div>

        <div class="stock-info">
            <p><i class='bx bx-package'></i> Stock online: 
                {% if not product.activo %}
                    <strong style="color: #e74c3c;">Producto no disponible</strong>
                {% elif product.stock > 0 %}
                    <strong>{{ product.stock }} unidades</strong>
                {% else %}
                    <strong>Agotado</strong>
                {% endif %}
            </p>
        </div>

        <div class="product-description">
            <h3>Descripción</h3>
            <p>{{ product.descripcion|linebreaks }}</p>
        </div>
    </div>
</div>

<div class="product-reviews-container">
    <h2>Reseñas de Clientes</h2>
    <div class="reviews-summary">
        <div class="summary-stars">
            {% if promedio_estrellas > 0 %}
                {% for i in "12345" %}
                    {% if i|add:0 <= promedio_estrellas %}
                        <i class='bx bxs-star'></i>
                    {% elif i|add:0 > promedio_estrellas and i|add:"-1" < promedio_estrellas %}
                        <i class='bx bxs-star-half'></i>
                    {% else %}
                        <i class='bx bx-star'></i>
                    {% endif %}
                {% endfor %}
                <span>{{ promedio_estrellas|floatformat:1 }} de 5 estrellas</span>
            {% else %}
                <i class='bx bx-star'></i>
                <i class='bx bx-star'></i>
                <i class='bx bx-star'></i>
                <i class='bx bx-star'></i>
                <i class='bx bx-star'></i>
                <span>Sin reseñas aún</span>
            {% endif %}
        </div>
        <p>Basado en {{ total_reseñas }} reseña{{ total_reseñas|pluralize }}</p>
    </div>

    {% if cliente_logueado %}
        <div class="review-form-container">
            <h3>Escribe tu propia reseña</h3>
            <form method="POST" class="review-form">
                {% csrf_token %}
                <div class="form-group-stars">
                    <label>{{ form_comentario.estrellas.label }}</label>
                    <div class="star-rating">
                        {% for radio in form_comentario.estrellas %}
                            {{ radio.tag }}
                            <label for="{{ radio.id_for_label }}"><i class='bx bxs-star'></i></label>
                        {% endfor %}
                    </div>
                    {{ form_comentario.estrellas.errors }}
                </div>
                <div class="form-group-content">
                    <label for="{{ form_comentario.contenido.id_for_label }}">{{ form_comentario.contenido.label }}</label>
                    {{ form_comentario.contenido }}
                    {{ form_comentario.contenido.errors }}
                </div>
                <button type="submit" name="submit_comentario" class="btn btn-primary" style="margin-top: 15px;">
                    Enviar Reseña
                </button>
            </form>
        </div>
    {% else %}
        <div class="review-form-login-prompt">
            <p>Debes <a href="{% url 'login' %}?next={{ request.path }}"><b>iniciar sesión</b></a> para dejar una reseña.</p>
        </div>
    {% endif %}
    <div class="review-list">
        {% for comentario in comentarios %}
        <div class="review-item">
            <div class="review-header">
                <div class="reviewer-info">
                    <span class="reviewer-name">{{ comentario.cliente.nombre }} {{ comentario.cliente.apellidos }}</span>
                </div>
                <div class="review-meta">
                    <div class="review-stars">
                        {% for i in "12345" %}
                            {% if i|add:0 <= comentario.estrellas %}
                                <i class='bx bxs-star'></i>
                            {% else %}
                                <i class='bx bx-star'></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="review-date">{{ comentario.fecha|naturaltime }}</span>
                </div>
            </div>
            <div class="review-body">
                <p>{{ comentario.contenido|linebreaks }}</p>
            </div>
        </div>
        {% empty %}
        <div class="review-item">
            <div class="review-body">
                <p>Aún no hay comentarios aprobados para este producto. ¡Sé el primero en dejar una reseña!</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="sticky-actions-bar">
    <div class="sticky-actions-content">
    
        <form action="{% url 'add_to_cart' product.id %}" method="POST" class="sticky-form" id="sticky-add-to-cart-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary" {% if not producto_disponible %}disabled{% endif %}>
                Agregar al carro
            </button>
        </form>
        
        <form action="{% url 'add_to_cart' product.id %}" method="POST" class="sticky-form">
            {% csrf_token %}
            <input type="hidden" name="next" value="checkout"> <input type="hidden" name="quantity" value="1">
            <button type="submit" class="btn btn-primary" id="sticky-buy-now-btn" {% if not producto_disponible %}disabled{% endif %}>
                Comprar ahora
            </button>
        </form>

    </div>
</div>

<button id="mobile-share-btn" class="floating-share-btn" aria-label="Compartir producto">
    <i class='bx bx-share-alt'></i>
</button>

<style>
    /* Estilos del botón flotante */
    .floating-share-btn {
        position: fixed;
        bottom: 85px; /* Altura para que quede encima de la barra pegajosa en móvil */
        left: 20px;   /* A la izquierda */
        width: 50px;
        height: 50px;
        background-color: #ffffff;
        color: #6a0dad;
        border: 2px solid #6a0dad;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        font-size: 24px;
        cursor: pointer;
        z-index: 9999;
        
        /* --- CAMBIO PRINCIPAL --- */
        display: flex; /* Ahora siempre es visible (antes era 'none') */
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
    }

    /* Efecto al pasar el mouse (útil para escritorio) */
    .floating-share-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(106, 13, 173, 0.3);
        background-color: #f9f9f9;
    }

    .floating-share-btn:active {
        transform: scale(0.9);
        background-color: #f0f0f0;
    }
    
    /* Tooltip simple para escritorio */
    .floating-share-btn::after {
        content: "Compartir";
        position: absolute;
        left: 60px; /* A la derecha del botón */
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        white-space: nowrap;
        pointer-events: none;
    }

    /* Mostrar tooltip solo al pasar el mouse en pantallas grandes */
    @media (min-width: 769px) {
        .floating-share-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        /* En escritorio, quizás quieras bajarlo un poco si no hay barra pegajosa */
        .floating-share-btn {
            bottom: 20px; 
        }
    }

    /* Animación de entrada */
    .floating-share-btn {
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
        from { opacity: 0; transform: scale(0) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // === LÓGICA ORIGINAL DE ZOOM E IMÁGENES ===
        const thumbnails = document.querySelectorAll('.thumb-item');
        const mainImage = document.getElementById('main-product-image');
        const container = document.getElementById('image-zoom-container');
        
        let isZooming = false;
        let currentImageSrc = mainImage.src;
        
        thumbnails.forEach(thumb => {
            thumb.addEventListener('click', function() {
                thumbnails.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                const imageUrl = this.getAttribute('data-image');
                mainImage.src = imageUrl;
                currentImageSrc = imageUrl;
            });
        });
        
        container.addEventListener('mouseenter', function() {
            isZooming = true;
            container.classList.add('zooming');
        });
        
        container.addEventListener('mouseleave', function() {
            isZooming = false;
            container.classList.remove('zooming');
            container.style.backgroundImage = 'none';
        });
        
        container.addEventListener('mousemove', function(e) {
            if (!isZooming) return;
            
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const xPercent = (x / rect.width) * 100;
            const yPercent = (y / rect.height) * 100;
            container.style.backgroundImage = `url('${currentImageSrc}')`;
            container.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
            container.style.backgroundSize = '250%'; 
        });

        // === ALERTAS DE STOCK ===
        {% if not producto_disponible %}
        Swal.fire({
            icon: 'warning',
            title: 'Producto no disponible',
            html: {% if not product.activo %}
                '<p>Este producto actualmente <strong>no está disponible</strong> para la venta.</p><p>Por favor, revisa nuestro catálogo para ver otros productos disponibles.</p>'
            {% else %}
                '<p>Este producto está <strong>agotado</strong> temporalmente.</p><p>Te invitamos a revisar nuestros otros productos.</p>'
            {% endif %},
            confirmButtonText: 'Ver catálogo',
            showCancelButton: true,
            cancelButtonText: 'Cerrar',
            confirmButtonColor: '#667eea',
            cancelButtonColor: '#6c757d'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/radios/';
            }
        });

        const allForms = document.querySelectorAll('#add-to-cart-form, #sticky-add-to-cart-form');
        const allBuyButtons = document.querySelectorAll('#buy-now-btn, #sticky-buy-now-btn');
        
        allForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Producto no disponible',
                    text: 'Este producto no está disponible para agregar al carrito.',
                    confirmButtonColor: '#667eea'
                });
            });
        });

        allBuyButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Producto no disponible',
                    text: 'Este producto no está disponible para comprar en este momento.',
                    confirmButtonColor: '#667eea'
                });
            });
        });
        {% endif %}
        
        // === LÓGICA NUEVA: COMPARTIR (WEB SHARE API) ===
        const shareBtn = document.getElementById('mobile-share-btn');
        if (shareBtn) {
            const shareData = {
                title: "{{ product.nombre|escapejs }}",
                text: "¡Mira este producto en TechTop! {{ product.nombre|escapejs }}",
                url: window.location.href
            };

            shareBtn.addEventListener('click', async () => {
                if (navigator.share) {
                    try {
                        await navigator.share(shareData);
                    } catch (err) {
                        console.log('Error al compartir:', err);
                    }
                } else {
                    // Fallback: Copiar al portapapeles
                    navigator.clipboard.writeText(window.location.href);
                    Swal.fire({
                        icon: 'success',
                        title: '¡Enlace copiado!',
                        text: 'El enlace del producto se copió al portapapeles',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }
    });
</script>
{% endblock %}