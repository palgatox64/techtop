{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load humanize %}

{% block title %}Revisar Transferencia #{{ pago.pedido.id }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/gestion.css' %}">
<style>
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
    .info-box { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .info-label { font-weight: bold; color: #555; }
    .total-highlight { font-size: 1.5rem; color: #6a0dad; font-weight: bold; }
    .proof-images { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
    .proof-img { width: 100%; max-width: 300px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; transition: transform 0.3s; }
    .proof-img:hover { transform: scale(1.05); }
    .action-buttons { display: flex; gap: 20px; margin-top: 30px; }
    /* Botones personalizados para acciones */
    .btn-approve, .btn-reject { 
        flex: 1; 
        padding: 15px; 
        border: none; 
        border-radius: 8px; 
        font-size: 1.1rem; 
        font-weight: bold; 
        cursor: pointer; 
        color: white; 
        transition: opacity 0.3s; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 10px; 
    }
    .btn-approve { background-color: #28a745; }
    .btn-reject { background-color: #dc3545; }
    .btn-approve:hover, .btn-reject:hover { opacity: 0.9; }
</style>

<div class="gestion-page">
    <header class="gestion-header">
        <h1>Revisar Pago Pedido #{{ pago.pedido.id }}</h1>
        <a href="{% url 'listar_transferencias' %}" class="btn-back-panel"><i class='bx bx-arrow-back'></i> Volver</a>
    </header>

    <div class="detail-grid">
        <div class="info-box">
            <h3>Información del Pedido</h3>
            <div class="info-row"><span class="info-label">ID Pedido:</span> <span>#{{ pago.pedido.id }}</span></div>
            <div class="info-row"><span class="info-label">Fecha Pedido:</span> <span>{{ pago.pedido.fecha_pedido|date:"d/m/Y H:i" }}</span></div>
            <div class="info-row"><span class="info-label">Cliente:</span> <span>{% if pago.pedido.cliente %}{{ pago.pedido.cliente.nombre }} {{ pago.pedido.cliente.apellidos }}{% else %}Anónimo{% endif %}</span></div>
            <div class="info-row"><span class="info-label">Total a Pagar:</span> <span class="total-highlight">${{ pago.pedido.total|floatformat:0|dot_thousands }}</span></div>
            
            <h4 style="margin-top: 20px;">Comentario del Cliente:</h4>
            <p style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; font-style: italic; color: #555;">
                {{ pago.comentario_usuario|default:"Sin comentarios." }}
            </p>
        </div>

        <div class="info-box">
            <h3>Comprobantes Adjuntos</h3>
            <p>Haz clic en la imagen para verla en tamaño completo.</p>
            <div class="proof-images">
                {% for comprobante in pago.comprobantes.all %}
                    <a href="{{ comprobante.imagen.url }}" target="_blank">
                        <img src="{{ comprobante.imagen.url }}" class="proof-img" alt="Comprobante de pago">
                    </a>
                {% empty %}
                    <p style="color: #999; font-style: italic;">No hay imágenes adjuntas a este pago.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if pago.estado == 'PENDIENTE' %}
    <div class="info-box" style="margin-top: 30px; text-align: center;">
        <h3>Acciones de Validación</h3>
        <p>Por favor, revisa tu cuenta bancaria y confirma si el monto exacto de <strong>${{ pago.pedido.total|floatformat:0|dot_thousands }}</strong> fue recibido.</p>
        
        <form method="POST" id="action-form" class="action-buttons">
            {% csrf_token %}
            <input type="hidden" name="accion" id="accion-input" value="">
            
            <button type="button" id="btn-reject" class="btn-reject">
                <i class='bx bx-x-circle'></i> Rechazar Pago
            </button>
            <button type="button" id="btn-approve" class="btn-approve">
                <i class='bx bx-check-circle'></i> Aprobar Pago
            </button>
        </form>
    </div>
    {% else %}
    <div class="info-box" style="margin-top: 30px; text-align: center; background-color: {% if pago.estado == 'APROBADO' %}#d4edda{% else %}#f8d7da{% endif %}; border: 1px solid {% if pago.estado == 'APROBADO' %}#c3e6cb{% else %}#f5c6cb{% endif %};">
        <h3 style="color: {% if pago.estado == 'APROBADO' %}#155724{% else %}#721c24{% endif %}; margin: 0;">
            Este pago ya fue {{ pago.get_estado_display|upper }}.
        </h3>
        <p style="margin-top: 10px; color: #666;">
            Fecha de revisión: <strong>{{ pago.fecha_revision|date:"d \d\e F Y, H:i"|default:"--" }}</strong>
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('action-form');
        const accionInput = document.getElementById('accion-input');
        const btnApprove = document.getElementById('btn-approve');
        const btnReject = document.getElementById('btn-reject');

        // Lógica para el botón de APROBAR
        if (btnApprove) {
            btnApprove.addEventListener('click', function() {
                Swal.fire({
                    title: '¿Aprobar Pago?',
                    text: "Estás confirmando que recibiste el dinero correctamente. El pedido pasará a estado 'Procesando'.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, aprobar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        accionInput.value = 'aprobar'; // Seteamos la acción
                        form.submit(); // Enviamos el formulario
                    }
                });
            });
        }

        // Lógica para el botón de RECHAZAR
        if (btnReject) {
            btnReject.addEventListener('click', function() {
                Swal.fire({
                    title: '¿Rechazar Pago?',
                    text: "¡Atención! El pedido será CANCELADO automáticamente y el stock se restaurará. Esta acción no se puede deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, rechazar y cancelar pedido',
                    cancelButtonText: 'Volver'
                }).then((result) => {
                    if (result.isConfirmed) {
                        accionInput.value = 'rechazar'; // Seteamos la acción
                        form.submit(); // Enviamos el formulario
                    }
                });
            });
        }
    });
</script>
{% endblock %}