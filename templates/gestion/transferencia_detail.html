{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Revisar Transferencia #{{ pago.pedido.id }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/gestion.css' %}">
<style>
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
    .info-box { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .info-label { font-weight: bold; color: #555; }
    .total-highlight { font-size: 1.5rem; color: #6a0dad; font-weight: bold; }
    .proof-images { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
    .proof-img { width: 100%; max-width: 300px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; transition: transform 0.3s; }
    .proof-img:hover { transform: scale(1.05); }
    .action-buttons { display: flex; gap: 20px; margin-top: 30px; }
    .btn-approve, .btn-reject { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; color: white; transition: opacity 0.3s; }
    .btn-approve { background-color: #28a745; }
    .btn-reject { background-color: #dc3545; }
    .btn-approve:hover, .btn-reject:hover { opacity: 0.9; }
</style>

<div class="gestion-page">
    <header class="gestion-header">
        <h1>Revisar Pago Pedido #{{ pago.pedido.id }}</h1>
        <a href="{% url 'listar_transferencias' %}" class="btn-back-panel"><i class='bx bx-arrow-back'></i> Volver</a>
    </header>

    <div class="detail-grid">
        <div class="info-box">
            <h3>Información del Pedido</h3>
            <div class="info-row"><span class="info-label">ID Pedido:</span> <span>#{{ pago.pedido.id }}</span></div>
            <div class="info-row"><span class="info-label">Fecha Pedido:</span> <span>{{ pago.pedido.fecha_pedido|date:"d/m/Y H:i" }}</span></div>
            <div class="info-row"><span class="info-label">Cliente:</span> <span>{% if pago.pedido.cliente %}{{ pago.pedido.cliente.nombre }} {{ pago.pedido.cliente.apellidos }}{% else %}Anónimo{% endif %}</span></div>
            <div class="info-row"><span class="info-label">Total a Pagar:</span> <span class="total-highlight">${{ pago.pedido.total|floatformat:0|dot_thousands }}</span></div>
            
            <h4 style="margin-top: 20px;">Comentario del Cliente:</h4>
            <p style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px;">
                {{ pago.comentario_usuario|default:"Sin comentarios." }}
            </p>
        </div>

        <div class="info-box">
            <h3>Comprobantes Adjuntos</h3>
            <p>Haz clic en la imagen para verla en tamaño completo.</p>
            <div class="proof-images">
                {% for comprobante in pago.comprobantes.all %}
                    <a href="{{ comprobante.imagen.url }}" target="_blank">
                        <img src="{{ comprobante.imagen.url }}" class="proof-img" alt="Comprobante">
                    </a>
                {% empty %}
                    <p>No hay imágenes adjuntas.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if pago.estado == 'PENDIENTE' %}
    <div class="info-box" style="margin-top: 30px; text-align: center;">
        <h3>Acciones</h3>
        <p>Revisa tu cuenta bancaria y confirma si el monto ${{ pago.pedido.total|floatformat:0|dot_thousands }} fue recibido.</p>
        <form method="POST" class="action-buttons">
            {% csrf_token %}
            <button type="submit" name="accion" value="rechazar" class="btn-reject" onclick="return confirm('¿Estás seguro de RECHAZAR este pago? El pedido será cancelado.')">
                <i class='bx bx-x-circle'></i> Rechazar Pago
            </button>
            <button type="submit" name="accion" value="aprobar" class="btn-approve" onclick="return confirm('¿Confirmas que recibiste el dinero?')">
                <i class='bx bx-check-circle'></i> Aprobar Pago
            </button>
        </form>
    </div>
    {% else %}
    <div class="info-box" style="margin-top: 30px; text-align: center; background-color: {% if pago.estado == 'APROBADO' %}#d4edda{% else %}#f8d7da{% endif %};">
        <h3>Este pago ya fue {{ pago.get_estado_display|lower }}.</h3>
        <p>Fecha de revisión: {{ pago.fecha_revision|date:"d/m/Y H:i" }}</p>
    </div>
    {% endif %}
</div>
{% endblock %}