{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Mis Compras - Techtop{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/gestion.css' %}">
<div class="gestion-page">
    <header class="gestion-header">
        <h1>Historial de Compras</h1>
        <a href="{% url 'perfil_usuario' %}" class="btn-back-panel"><i class='bx bx-arrow-back'></i> Volver al Perfil</a>
    </header>

    <div class="table-responsive">
        <table class="crud-table">
            <thead>
                <tr>
                    <th>Pedido #</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Detalles</th>
                </tr>
            </thead>
            <tbody>
                {% for pedido in page_obj %}
                <tr>
                    <td>#{{ pedido.id }}</td>
                    <td>{{ pedido.fecha_pedido|date:"d/m/Y" }}</td>
                    <td>${{ pedido.total|floatformat:0|dot_thousands }}</td>
                    <td><span class="badge status-{{ pedido.estado }}">{{ pedido.get_estado_display }}</span></td>
                    <td>
                        <a href="{% url 'detalle_compra' pedido.id %}" class="btn-action" style="background:#6a0dad; color:white;">Ver</a>
                    </td>
                    <td>
                        <span class="badge {% if pedido.estado == 'pendiente' %}bg-warning{% elif pedido.estado == 'cancelado' %}bg-danger{% else %}bg-success{% endif %}">
                            {{ pedido.get_estado_display }}
                        </span>

                        {% if pedido.puede_continuar_pago %}
                            <div class="mt-2">
                                <small class="text-muted d-block mb-1" style="font-size: 0.8rem;">
                                    <i class="far fa-clock"></i> Tienes 1 hora para pagar
                                </small>
                                <a href="{% url 'reanudar_pago' pedido.id %}" class="btn btn-primary btn-sm">
                                    Pagar Ahora
                                </a>
                            </div>
                        {% endif %}

                        {% if pedido.estado == 'pendiente' and not pedido.puede_continuar_pago %}
                            <div class="mt-1">
                                <small class="text-danger">Expirado (Se cancelar√° pronto)</small>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" style="text-align: center; padding: 30px;">No tienes pedidos registrados.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>
{% endblock %}